# Electron 踩坑记录

本文档记录在使用 Electron 开发过程中遇到的各种问题和解决方案。

---

## 软件更新

### 问题 2: 自动更新报错 (0 , builder_util_runtime_1.retry) is not a function

**问题描述：**
在使用 electron-updater 实现自动更新功能时，应用启动或执行检查更新时直接报错，更新流程中断。

**项目环境：**
- 使用 electron-builder
- 使用 electron-updater
- 使用 pnpm 作为包管理工具
- 打包后为 app.asar

**错误信息：**
```
TypeError: (0 , builder_util_runtime_1.retry) is not a function
    at ...\resources\app.asar\dist-electron\main\index.js:4:322
```

有时堆栈中还能看到：
- `MacUpdater.executeDownload`
- `AppImageUpdater.doDownloadUpdate`

**问题分析：**

electron-updater 内部依赖 builder-util-runtime 包中的 retry 方法。

报错的根本原因是：**运行时环境中找不到 builder-util-runtime.retry 函数**。

出现这种情况通常是：
- builder-util-runtime 没有被正确安装
- 使用 pnpm 时依赖被「提升隔离」，没有出现在最终运行环境中
- 打包时没有正确包含该依赖
- 版本冲突导致方法不存在

⚠️ **使用 pnpm 时更容易出现这种问题**，因为它采用的是严格依赖隔离机制。

**解决方案：**

#### ✅ 直接安装缺失依赖

执行：
```bash
pnpm install builder-util-runtime
```

安装完成后重新打包，问题解决。

**原理说明：**

electron-updater 虽然依赖 builder-util-runtime，但在某些版本组合或 pnpm 环境下：
- 依赖没有被正确提升到可运行层级
- 或打包阶段未被正确包含进 asar

手动安装后：
- 依赖被明确加入到项目 dependencies
- 打包时可以正确包含
- 运行时 retry 方法存在

**如何排查类似问题：**

遇到类似报错 `xxx is not a function` 时，排查思路：
1. 查看报错来源模块（本例为 builder-util-runtime）
2. 检查该模块是否存在：`pnpm list builder-util-runtime`
3. 如果未列出或版本异常 → 手动安装
4. 删除 node_modules 后重新安装
5. 重新打包测试

**经验总结：**
- 使用 pnpm 时，自动更新相关依赖建议显式安装
- electron-updater 并非完全「零配置」，依赖链问题比较隐蔽
- 出现 `is not a function`，优先怀疑：依赖缺失、版本不匹配、打包未包含

**额外建议：**

如果后续仍有自动更新异常，可以检查：
- electron-builder 版本
- electron-updater 版本
- publish 配置是否正确
- 是否开启了 asar
- 是否使用了 external 排除依赖

---
